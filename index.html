<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Family Tree Creator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --blue: #cbe6ff;
      --pink: #ffe4eb;
      --sidebar-bg: #f7f9fa;
      --canvas-bg: #fff;
      --border: #d1dbe4;
      --highlight: #5e9cff;
      --person-shadow: 0 2px 8px rgba(0,0,0,.08);
      --modal-bg: #fff;
      --modal-overlay: rgba(0,0,0,0.25);
      --modal-border: #aacbe6;
      --menu-btn-bg: #eaf1fb;
      --menu-btn-hover: #d3e6fa;
      --delete: #e96363;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, Arial, sans-serif;
      background: var(--canvas-bg);
      color: #263648;
    }
    body {
      min-height: 100vh;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    #app-wrapper {
      display: flex;
      flex: 1 1 0;
      height: 100vh;
      overflow: hidden;
    }
    #sidebar {
      width: 280px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      padding: 0;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      z-index: 1;
    }
    #sidebar-header {
      padding: 24px 16px 8px 16px;
      border-bottom: 1px solid var(--border);
      background: #f0f4fa;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .menu-btn {
      background: var(--menu-btn-bg);
      border: none;
      border-radius: 5px;
      padding: 10px 18px;
      font-weight: 500;
      cursor: pointer;
      transition: background .2s;
      margin-bottom: 5px;
    }
    .menu-btn:hover {
      background: var(--menu-btn-hover);
    }
    #person-list {
      flex: 1 1 0;
      overflow-y: auto;
      padding: 8px 0 8px 0;
      background: var(--sidebar-bg);
    }
    .person-list-item {
      padding: 10px 16px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background .15s;
      gap: 11px;
      user-select: none;
    }
    .person-list-item:hover {
      background: #f0f6fb;
    }
    .person-photo-thumb {
      width: 32px;
      height: 32px;
      border-radius: 5px;
      object-fit: cover;
      background: #ccd5e0;
      margin-right: 3px;
    }
    #canvas-area {
      flex: 1 1 0;
      overflow: auto;
      position: relative;
      background: var(--canvas-bg);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    /* Centered message for empty state */
    #empty-state {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: 0; left: 0; bottom: 0; right: 0;
      z-index: 0;
      background: var(--canvas-bg);
    }
    #add-first-btn {
      background: var(--highlight);
      color: #fff;
      border: none;
      font-size: 1.4em;
      padding: 26px 38px;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: var(--person-shadow);
      font-weight: bold;
      transition: background .15s;
    }
    #add-first-btn:hover {
      background: #488ad8;
    }
    /* Canvas and nodes */
    #tree-canvas {
      position: relative;
      min-width: 900px;
      padding: 65px 10px 40px 10px;
      background: var(--canvas-bg);
    }
    .person-node {
      position: absolute;
      min-width: 140px;
      min-height: 58px;
      padding: 10px 12px;
      border-radius: 8px;
      box-shadow: var(--person-shadow);
      border: 2px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      cursor: pointer;
      transition: box-shadow .18s, border .18s;
      z-index: 2;
      font-size: 16px;
      background: var(--blue);
      user-select: none;
    }
    .person-node[data-gender="female"] {
      background: var(--pink);
    }
    .person-node.selected {
      border: 2px solid var(--highlight);
      box-shadow: 0 4px 14px rgba(85,167,220,.11);
    }
    .person-node .edit-btn {
      position: absolute;
      top: 6px; right: 7px;
      background: #567dad;
      color: #fff;
      padding: 2px 7px;
      border-radius: 5px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      transition: background .15s;
      z-index: 6;
    }
    .person-node .edit-btn:hover {
      background: #3560a3;
    }
    .person-content {
      display: flex;
      align-items: center;
      gap: 13px;
      width: 100%;
    }
    .person-photo {
      width: 35px;
      height: 35px;
      border-radius: 6px;
      background: #ccd5e0;
      object-fit: cover;
      margin-right: 5px;
    }
    .person-info {
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 1px;
    }
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Family Tree Creator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --blue: #cbe6ff;
      --pink: #ffe4eb;
      --sidebar-bg: #f7f9fa;
      --canvas-bg: #fff;
      --border: #d1dbe4;
      --highlight: #5e9cff;
      --person-shadow: 0 2px 8px rgba(0,0,0,.08);
      --modal-bg: #fff;
      --modal-overlay: rgba(0,0,0,0.25);
      --modal-border: #aacbe6;
      --menu-btn-bg: #eaf1fb;
      --menu-btn-hover: #d3e6fa;
      --delete: #e96363;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, Arial, sans-serif;
      background: var(--canvas-bg);
      color: #263648;
    }
    body {
      min-height: 100vh;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    #app-wrapper {
      display: flex;
      flex: 1 1 0;
      height: 100vh;
      overflow: hidden;
    }
    #sidebar {
      width: 280px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      padding: 0;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      z-index: 1;
    }
    #sidebar-header {
      padding: 24px 16px 8px 16px;
      border-bottom: 1px solid var(--border);
      background: #f0f4fa;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .menu-btn {
      background: var(--menu-btn-bg);
      border: none;
      border-radius: 5px;
      padding: 10px 18px;
      font-weight: 500;
      cursor: pointer;
      transition: background .2s;
      margin-bottom: 5px;
    }
    .menu-btn:hover {
      background: var(--menu-btn-hover);
    }
    #person-list {
      flex: 1 1 0;
      overflow-y: auto;
      padding: 8px 0 8px 0;
      background: var(--sidebar-bg);
    }
    .person-list-item {
      padding: 10px 16px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background .15s;
      gap: 11px;
      user-select: none;
    }
    .person-list-item:hover {
      background: #f0f6fb;
    }
    .person-photo-thumb {
      width: 32px;
      height: 32px;
      border-radius: 5px;
      object-fit: cover;
      background: #ccd5e0;
      margin-right: 3px;
    }
    #canvas-area {
      flex: 1 1 0;
      overflow: auto;
      position: relative;
      background: var(--canvas-bg);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    #empty-state {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: 0; left: 0; bottom: 0; right: 0;
      z-index: 0;
      background: var(--canvas-bg);
    }
    #add-first-btn {
      background: var(--highlight);
      color: #fff;
      border: none;
      font-size: 1.4em;
      padding: 26px 38px;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: var(--person-shadow);
      font-weight: bold;
      transition: background .15s;
    }
    #add-first-btn:hover {
      background: #488ad8;
    }
    #tree-canvas {
      position: relative;
      min-width: 900px;
      padding: 65px 10px 40px 10px;
      background: var(--canvas-bg);
    }
    .person-node {
      position: absolute;
      min-width: 140px;
      min-height: 58px;
      padding: 10px 12px;
      border-radius: 8px;
      box-shadow: var(--person-shadow);
      border: 2px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      cursor: pointer;
      transition: box-shadow .18s, border .18s;
      z-index: 2;
      font-size: 16px;
      background: var(--blue);
      user-select: none;
    }
    .person-node[data-gender="female"] {
      background: var(--pink);
    }
    .person-node.selected {
      border: 2px solid var(--highlight);
      box-shadow: 0 4px 14px rgba(85,167,220,.11);
    }
    .person-node .edit-btn {
      position: absolute;
      top: 6px; right: 7px;
      background: #567dad;
      color: #fff;
      padding: 2px 7px;
      border-radius: 5px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      transition: background .15s;
      z-index: 6;
    }
    .person-node .edit-btn:hover {
      background: #3560a3;
    }
    .person-content {
      display: flex;
      align-items: center;
      gap: 13px;
      width: 100%;
    }
    .person-photo {
      width: 35px;
      height: 35px;
      border-radius: 6px;
      background: #ccd5e0;
      object-fit: cover;
      margin-right: 5px;
    }
    .person-info {
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 1px;
    }
    .person-name {
      font-weight: 600;
      font-size: 1.1em;
      color: #23406d;
    }
    .person-dates {
      font-size: 0.95em;
      color: #607cad;
      font-weight: 500;
      margin-top: 2px;
    }
    .tree-line {
      position: absolute;
      z-index: 1;
      pointer-events: none;
    }
    #modal-overlay {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: var(--modal-overlay);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 77;
    }
    #person-modal {
      background: var(--modal-bg);
      padding: 32px 26px 26px 26px;
      border-radius: 13px;
      box-shadow: 0 8px 36px rgba(0,0,0,.23);
      min-width: 360px;
      min-height: 400px;
      position: relative;
      border: 2px solid var(--modal-border);
      max-width: 96vw;
      max-height: 95vh;
      overflow-y: auto;
    }
    #person-modal .modal-header {
      font-size: 1.22em;
      font-weight: bold;
      margin-bottom: 22px;
      color: #2060a3;
    }
    .form-group {
      margin-bottom: 18px;
      display: flex;
      flex-direction: column;
    }
    .form-label {
      font-weight: 500;
      margin-bottom: 7px;
      font-size: 1em;
      color: #415987;
    }
    .form-field, .form-select {
      border-radius: 5px;
      border: 1.3px solid var(--border);
      height: 36px;
      font-size: 1.08em;
      padding: 7px 9px;
      background: #f6f7ff;
      color: #323858;
      outline: none;
      margin-bottom: 0;
      transition: border .15s;
      font-family: inherit;
    }
    .form-field:focus, .form-select:focus {
      border-color: var(--highlight);
      background: #fefbff;
    }
    .gender-radio-group {
      display: flex;
      gap: 14px;
      align-items: center;
    }
    .gender-radio label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-weight: 500;
      cursor: pointer;
      font-size: 1em;
    }
    .gender-radio input[type="radio"] {
      accent-color: var(--highlight);
      margin-right: 4px;
    }
    .photo-preview {
      margin-top: 6px;
      width: 52px; height: 52px;
      border-radius: 5px;
      object-fit: cover;
      background: #dbe8f5;
      display: block;
      box-shadow: var(--person-shadow);
      border: 1px solid var(--border);
    }
    .modal-actions {
      display: flex;
      gap: 17px;
      margin-top: 27px;
      align-items: center;
      flex-wrap: wrap;
    }
    .modal-actions .save-btn {
      background: var(--highlight);
      color: #fff;
      border-radius: 6px;
      padding: 9px 26px;
      font-size: 1em;
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: background .15s;
    }
    .modal-actions .save-btn:hover {
      background: #357cd7;
    }
    .modal-actions .delete-btn {
      background: var(--delete);
      color: #fff;
      border-radius: 6px;
      padding: 9px 23px;
      font-size: 1em;
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: background .14s;
    }
    .modal-actions .delete-btn:hover {
      background: #b94545;
    }
    .modal-actions .relation-btn {
      background: #eaf0fc;
      color: #2060a3;
      border-radius: 5px;
      padding: 8px 13px;
      font-size: .98em;
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: background .13s;
      border: 1px solid #cae3fd;
    }
    .modal-actions .relation-btn:hover {
      background: #cae3fd;
      color: #23406d;
    }
    .modal-close-btn {
      position: absolute;
      top: 11px; right: 16px;
      background: none;
      border: none;
      font-size: 1.7em;
      color: #4b7dba;
      font-weight: bold;
      cursor: pointer;
      z-index: 12;
      transition: color .13s;
    }
    .modal-close-btn:hover {
      color: #d71a61;
    }
    .relation-select-dropdown {
      border-radius: 6px;
      margin-top: 7px;
      margin-bottom: 15px;
      min-width: 220px;
      padding: 13px;
      background: #f1f8ff;
      border: 1.1px solid var(--border);
    }
    .form-field[type="file"] {
      height: auto;
      padding: 3px 0;
      background: none;
      border: none;
    }
    ::-webkit-scrollbar {
      width: 9px;
      background: #ecf2f8;
    }
    ::-webkit-scrollbar-thumb {
      background: #b2c5d9;
      border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb:active {
      background: #4b7dba;
    }
    @media (max-width: 800px) {
      #sidebar { width: 100vw; }
      #canvas-area { min-width: 100vw; }
      #tree-canvas { min-width: 100vw; }
      .person-node { min-width: 108px; font-size: 14px; }
    }
  </style>
</head>
<body>
  <div id="app-wrapper">
    <aside id="sidebar">
      <div id="sidebar-header">
        <button class="menu-btn" id="import-btn">Import Data</button>
        <button class="menu-btn" id="export-btn">Export Data</button>
        <hr style="border:none; background:#c1d0e4; height:1.5px; margin:12px 0 5px 0;">
        <span style="font-size:1.07em;font-weight:600;color:#2060a3;margin-bottom:4px;">Persons</span>
      </div>
      <div id="person-list"></div>
    </aside>
    <main id="canvas-area">
      <div id="empty-state" style="display:none;">
        <button id="add-first-btn">Add First Person</button>
      </div>
      <div id="tree-canvas"></div>
    </main>
  </div>
  <div id="modal-overlay" style="display:none;">
    <form id="person-modal" autocomplete="off">
      <button type="button" class="modal-close-btn" aria-label="Close">&times;</button>
      <div class="modal-header" id="modal-title"></div>
      <div class="form-group">
        <label class="form-label">Photo</label>
        <input type="file" class="form-field" id="photo-input" accept="image/*">
        <img class="photo-preview" id="photo-preview" src="" alt="" style="display:none;">
      </div>
      <div class="form-group">
        <label class="form-label">First Name *</label>
        <input type="text" class="form-field" id="first-name" required maxlength="30">
      </div>
      <div class="form-group">
        <label class="form-label">Last Name *</label>
        <input type="text" class="form-field" id="last-name" required maxlength="30">
      </div>
      <div class="form-group">
        <label class="form-label">Birth Year *</label>
        <input type="number" class="form-field" id="birth-year" min="1000" max="2100" required>
      </div>
      <div class="form-group">
        <label class="form-label">Death Year</label>
        <input type="number" class="form-field" id="death-year" min="1000" max="2100">
      </div>
      <div class="form-group">
        <label class="form-label">Gender *</label>
        <div class="gender-radio-group">
          <label class="gender-radio"><input type="radio" name="gender" value="male" required>Male</label>
          <label class="gender-radio"><input type="radio" name="gender" value="female" required>Female</label>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="relation-btn" id="add-parent-btn">Add Parent</button>
        <button type="button" class="relation-btn" id="add-child-btn">Add Child</button>
        <button type="submit" class="save-btn" id="save-person-btn">Save</button>
        <button type="button" class="delete-btn" id="delete-person-btn">Delete Person</button>
      </div>
      <div id="relation-select-area"></div>
    </form>
  </div>
  <input type="file" id="import-file-input" accept="application/json" style="display:none;">
  <script>
    let appState = { app: { settings: {}, tree: { persons: [], relations: [] } } };
    let unsavedChanges = false;
    let selectedPersonId = null;
    let treeCanvas = document.getElementById('tree-canvas');
    let modalOverlay = document.getElementById('modal-overlay');
    let emptyState = document.getElementById('empty-state');
    function uuidv4() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      );
    }
    function setUnsaved(val) {
      unsavedChanges = val;
    }
    window.onbeforeunload = function(e) {
      if (unsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
        return '';
      }
    };
    function showEmptyState(show) {
      emptyState.style.display = show ? 'flex' : 'none';
      treeCanvas.style.display = show ? 'none' : 'block';
    }
    function personById(pid) {
      return appState.app.tree.persons.find(p => p.id === pid);
    }
    function updateSidebarPersons() {
      const list = document.getElementById('person-list');
      list.innerHTML = '';
      appState.app.tree.persons.forEach(person => {
        const div = document.createElement('div');
        div.className = 'person-list-item';
        div.tabIndex = 0;
        div.setAttribute('data-personid', person.id);
        const img = document.createElement('img');
        img.className = 'person-photo-thumb';
        img.src = person.photo || '';
        img.alt = 'Photo';
        if (!person.photo) img.style.display = 'none';
        div.appendChild(img);
        div.innerHTML += `<span>${person.firstName} ${person.lastName} (${person.birthDate}${person.deathDate ? '-' + person.deathDate : ''})</span>`;
        div.onclick = () => openPersonModal(person.id);
        div.ondblclick = () => openPersonModal(person.id);
        list.appendChild(div);
      });
    }
    function ensureAppStateValid(obj) {
      if (!obj || typeof obj !== "object") return false;
      const s = obj.app?.tree;
      if (!s || !Array.isArray(s.persons) || !Array.isArray(s.relations)) return false;
      for (let p of s.persons) {
        if (!p.id || !p.firstName || !p.lastName || !p.birthDate || !['male','female'].includes(p.gender)) return false;
      }
      for (let r of s.relations) {
        if (!r.from || !r.to || !['parent','child','spouse'].includes(r.type)) return false;
      }
      return true;
    }
    function yearToYearStr(birth, death) {
      return birth + (death ? ('-' + death) : '');
    }
    function photoBase64OrDefault(photo) {
      return photo || '';
    }
    function renderTreeCanvas() {
      treeCanvas.innerHTML = '';
      if (appState.app.tree.persons.length === 0) return showEmptyState(true);
      showEmptyState(false);
      const pidToPerson = {};
      const parentsMap = {};
      const childrenMap = {};
      for (const p of appState.app.tree.persons) pidToPerson[p.id] = p;
      appState.app.tree.persons.forEach(p => {
        parentsMap[p.id] = [];
        childrenMap[p.id] = [];
      });
      (appState.app.tree.relations || []).forEach(rel => {
        if (rel.type === 'parent') {
          childrenMap[rel.from].push(rel.to);
          parentsMap[rel.to].push(rel.from);
        } else if (rel.type === 'child') {
          childrenMap[rel.to].push(rel.from);
          parentsMap[rel.from].push(rel.to);
        }
      });
      const roots = appState.app.tree.persons.filter(p => parentsMap[p.id].length === 0);
      let levels = [];
      let visited = {};
      let currLevel = roots.map(p => p.id);
      let used = [];
      while (currLevel.length) {
        levels.push([...currLevel]);
        currLevel.forEach(pid => visited[pid] = true);
        let next = [];
        currLevel.forEach(pid => {
          childrenMap[pid].forEach(cid => {
            if (!visited[cid]) next.push(cid);
          });
        });
        currLevel = Array.from(new Set(next));
      }
      const allPids = appState.app.tree.persons.map(p => p.id);
      const placed = levels.flat();
      const orphans = allPids.filter(pid => !placed.includes(pid));
      if (orphans.length) levels.push(orphans);
      const nodePos = {};
      const levelH = 120;
      const nodeW = 160, nodeH = 70, gapX = 40, gapY = levelH;
      let canvasW = Math.max(900, levels.reduce((mx, lv) => Math.max(mx, lv.length * (nodeW + gapX)), 0));
      let canvasH = 80 + levels.length * gapY;
      treeCanvas.style.width = canvasW + "px";
      treeCanvas.style.height = canvasH + "px";
      levels.forEach((lvl, lidx) => {
        const rowY = 30 + lidx * gapY;
        const rowW = lvl.length * nodeW + (lvl.length-1)*gapX;
        let startX = (canvasW - rowW) / 2;
        lvl.forEach((pid, i) => {
          nodePos[pid] = {
            x: startX + i*(nodeW + gapX),
            y: rowY
          };
        });
      });
      appState.app.tree.relations.forEach(rel => {
        if (["parent","child"].includes(rel.type)) {
          let from = rel.type === "parent" ? rel.from : rel.to;
          let to = rel.type === "parent" ? rel.to : rel.from;
          if (nodePos[from] && nodePos[to]) {
            let x1 = nodePos[from].x + nodeW/2, y1 = nodePos[from].y + nodeH;
            let x2 = nodePos[to].x + nodeW/2, y2 = nodePos[to].y;
            let line = document.createElement('div');
            line.className = 'tree-line';
            line.innerHTML = `<svg width="${Math.abs(x2-x1)+5}" height="${Math.abs(y2-y1)+5}">
              <line x1="${x1<=x2?3:Math.abs(x2-x1)-3}" y1="3" x2="${x1<=x2?Math.abs(x2-x1)-3:3}" y2="${Math.abs(y2-y1)-3}" stroke="#94b1d4" stroke-width="3" />
            </svg>`;
            line.style.left = Math.min(x1,x2)+'px';
            line.style.top = Math.min(y1,y2)+'px';
            treeCanvas.appendChild(line);
          }
        }
      });
      appState.app.tree.relations.forEach(rel => {
        if (rel.type==="spouse" && nodePos[rel.from] && nodePos[rel.to]) {
          let A = nodePos[rel.from], B = nodePos[rel.to];
          let y = A.y + nodeH/2;
          let x1 = A.x + nodeW - 15, x2 = B.x + 15;
          let line = document.createElement('div');
          line.className = 'tree-line';
          line.innerHTML = `<svg width="${Math.abs(x2-x1)+5}" height="12">
            <line x1="${x1<=x2?3:Math.abs(x2-x1)-3}" y1="6" x2="${x1<=x2?Math.abs(x2-x1)-3:3}" y2="6" stroke="#e2a5b6" stroke-width="4" stroke-dasharray="8 6"/>
          </svg>`;
          line.style.left = Math.min(x1,x2)+'px';
          line.style.top = y+'px';
          treeCanvas.appendChild(line);
        }
      });
      appState.app.tree.persons.forEach(p => {
        const pos = nodePos[p.id] || {x:30,y:30};
        const nodeDiv = document.createElement('div');
        nodeDiv.className = 'person-node';
        nodeDiv.tabIndex = 0;
        nodeDiv.setAttribute('data-personid', p.id);
        nodeDiv.setAttribute('data-gender', p.gender);
        nodeDiv.style.left = pos.x + "px";
        nodeDiv.style.top = pos.y + "px";
        nodeDiv.innerHTML = `<button class="edit-btn" tabindex="0">Edit</button>
          <div class="person-content">
            <img class="person-photo" src="${photoBase64OrDefault(p.photo)}" style="${p.photo?'':'display:none'}" alt="Photo">
            <div class="person-info">
              <span class="person-name">${p.firstName} ${p.lastName}</span>
              <span class="person-dates">${yearToYearStr(p.birthDate, p.deathDate)}</span>
            </div>
          </div>`;
        nodeDiv.querySelector('.edit-btn').onclick = (ev) => {ev.stopPropagation(); openPersonModal(p.id);}
        nodeDiv.ondblclick = (ev) => openPersonModal(p.id);
        treeCanvas.appendChild(nodeDiv);
      });
    }
    function openPersonModal(personId, opts={ create:false }) {
      selectedPersonId = personId;
      const modal = document.getElementById('person-modal');
      document.getElementById('relation-select-area').innerHTML = '';
      let editingPerson = opts.create
        ? { id: uuidv4(), photo: '', firstName: '', lastName: '', birthDate: '', deathDate: '', gender: 'male' }
        : personById(personId);
      document.getElementById('modal-title').innerText = opts.create ? 'Add New Person' : 'Edit Person';
      document.getElementById('photo-preview').src = '';
      document.getElementById('photo-preview').style.display = editingPerson.photo ? 'block' : 'none';
      document.getElementById('photo-input').value = '';
      document.getElementById('first-name').value = editingPerson.firstName || '';
      document.getElementById('last-name').value = editingPerson.lastName || '';
      document.getElementById('birth-year').value = editingPerson.birthDate || '';
      document.getElementById('death-year').value = editingPerson.deathDate || '';
      document.querySelector('[name="gender"][value="male"]').checked = editingPerson.gender === 'male';
      document.querySelector('[name="gender"][value="female"]').checked = editingPerson.gender === 'female';
      document.getElementById('delete-person-btn').style.display = opts.create ? 'none' : 'inline-block';
      modalOverlay.style.display = 'flex';
      setTimeout(() => {document.getElementById('first-name').focus();}, 180);
      document.getElementById('save-person-btn').onclick = function(ev) {
        ev.preventDefault();
        let fn = document.getElementById('first-name').value.trim();
        let ln = document.getElementById('last-name').value.trim();
        let by = document.getElementById('birth-year').value.trim();
        let dy = document.getElementById('death-year').value.trim();
        let gender = document.querySelector('[name="gender"]:checked')?.value;
        if (!fn || !ln || !by || !gender) {
          alert("Please fill in all required fields.");
          return false;
        }
        let updatedPerson = Object.assign(editingPerson, {
          firstName: fn, lastName: ln, birthDate: by, deathDate: dy,
          gender: gender
        });
        if (opts.create) {
          appState.app.tree.persons.push(updatedPerson);
        }
        setUnsaved(true);
        closeModal();
        renderAll();
        return false;
      };
      document.getElementById('delete-person-btn').onclick = function(ev) {
        if (!confirm("Delete this person?\nWARNING: This will remove all relationships involving them.")) return;
        let pid = editingPerson.id;
        appState.app.tree.persons = appState.app.tree.persons.filter(p => p.id !== pid);
        appState.app.tree.relations = appState.app.tree.relations.filter(r => r.from !== pid && r.to !== pid);
        setUnsaved(true);
        closeModal();
        renderAll();
      };
      document.getElementById('photo-input').onchange = function(e) {
        let file = e.target.files[0];
        if (!file) return;
        let reader = new FileReader();
        reader.onload = function(ev) {
          editingPerson.photo = ev.target.result;
          document.getElementById('photo-preview').src = editingPerson.photo || '';
          document.getElementById('photo-preview').style.display = editingPerson.photo ? 'block' : 'none';
        };
        reader.readAsDataURL(file);
      };
      document.getElementById('add-parent-btn').onclick = function(ev){
        ev.preventDefault();
        showRelationSelector(editingPerson.id, 'parent');
      };
      document.getElementById('add-child-btn').onclick = function(ev){
        ev.preventDefault();
        showRelationSelector(editingPerson.id, 'child');
      };
    }
    function closeModal() {
      modalOverlay.style.display = 'none';
      selectedPersonId = null;
      document.getElementById('relation-select-area').innerHTML = '';
    }
    document.querySelector('.modal-close-btn').onclick = closeModal;
    modalOverlay.onclick = function(ev) {
      if (ev.target === modalOverlay) closeModal();
    };
    window.addEventListener('keydown', function(e){
      if (modalOverlay.style.display === 'flex' && e.key === 'Escape') {
        closeModal();
      }
    });
    function showRelationSelector(basePersonId, relType) {
      let area = document.getElementById('relation-select-area');
      area.innerHTML = '';
      let candidates = appState.app.tree.persons.filter(p => p.id !== basePersonId);
      let labelType = relType === 'parent' ? 'Select Parent' : 'Select Child';
      let dropdown = document.createElement('select');
      dropdown.className = 'form-select relation-select-dropdown';
      dropdown.innerHTML = `<option value="">-- ${labelType} --</option>`;
      candidates.forEach(p => {
        dropdown.innerHTML += `<option value="${p.id}">${p.firstName} ${p.lastName} (${p.birthDate}${p.deathDate ? '-' + p.deathDate : ''})</option>`;
      });
      area.appendChild(dropdown);
      let addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.className = 'relation-btn';
      addBtn.innerText = `Link Existing`;
      let createBtn = document.createElement('button');
      createBtn.type = 'button';
      createBtn.className = 'relation-btn';
      createBtn.innerText = `Create New`;
      let cancelBtn = document.createElement('button');
      cancelBtn.type = 'button';
      cancelBtn.className = 'delete-btn';
      cancelBtn.style.padding = '7px 19px';
      cancelBtn.innerText = 'Cancel';
      let btnArea = document.createElement('div');
      btnArea.style = 'display:flex;gap:12px;margin-top:7px;';
      btnArea.appendChild(addBtn); btnArea.appendChild(createBtn); btnArea.appendChild(cancelBtn);
      area.appendChild(btnArea);
      addBtn.onclick = function(){
        let selectedId = dropdown.value;
        if (!selectedId) { alert("Please choose a person."); return; }
        if (relType === 'parent') {
          appState.app.tree.relations.push({ from: selectedId, to: basePersonId, type: 'parent' });
        } else if (relType === 'child') {
          appState.app.tree.relations.push({ from: basePersonId, to: selectedId, type: 'parent' });
        }
        setUnsaved(true);
        area.innerHTML = '';
        renderAll();
      };
      createBtn.onclick = function(){
        area.innerHTML = '';
        openPersonModal(null, { create: true });
        let origSaveBtn = document.getElementById('save-person-btn').onclick;
        document.getElementById('save-person-btn').onclick = function(ev) {
          ev.preventDefault();
          let fn = document.getElementById('first-name').value.trim();
          let ln = document.getElementById('last-name').value.trim();
          let by = document.getElementById('birth-year').value.trim();
          let dy = document.getElementById('death-year').value.trim();
          let gender = document.querySelector('[name="gender"]:checked')?.value;
          if (!fn || !ln || !by || !gender) {
            alert("Please fill in all required fields.");
            return false;
          }
          let newPerson = {
            id: uuidv4(),
            photo: '',
            firstName: fn, lastName: ln, birthDate: by, deathDate: dy, gender: gender
          };
          let photoInput = document.getElementById('photo-input');
          if (photoInput.files[0]) {
            let reader = new FileReader();
            reader.onload = function(ev) {
              newPerson.photo = ev.target.result;
              appState.app.tree.persons.push(newPerson);
              if (relType === 'parent') {
                appState.app.tree.relations.push({ from: newPerson.id, to: basePersonId, type: 'parent' });
              } else if (relType === 'child') {
                appState.app.tree.relations.push({ from: basePersonId, to: newPerson.id, type: 'parent' });
              }
              setUnsaved(true);
              closeModal();
              renderAll();
            };
            reader.readAsDataURL(photoInput.files[0]);
          } else {
            appState.app.tree.persons.push(newPerson);
            if (relType === 'parent') {
              appState.app.tree.relations.push({ from: newPerson.id, to: basePersonId, type: 'parent' });
            } else if (relType === 'child') {
              appState.app.tree.relations.push({ from: basePersonId, to: newPerson.id, type: 'parent' });
            }
            setUnsaved(true);
            closeModal();
            renderAll();
          }
          return false;
        };
      };
      cancelBtn.onclick = function(){ area.innerHTML = ''; };
    }
    document.getElementById('export-btn').onclick = function(){
      let dataStr = JSON.stringify(appState, null, 2);
      let blob = new Blob([dataStr], {type:"application/json"});
      let a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = "family_tree.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setUnsaved(false);
    };
    document.getElementById('import-btn').onclick = function(){
      let input = document.getElementById('import-file-input');
      input.value = '';
      input.click();
    };
    document.getElementById('import-file-input').onchange = function(e){
      let file = e.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function(ev) {
        try {
          let json = JSON.parse(ev.target.result);
          if (!ensureAppStateValid(json)) {
            alert("Invalid family tree JSON structure.");
            return;
          }
          appState = json;
          setUnsaved(false);
          renderAll();
        } catch (err){
          alert("Invalid JSON file.");
        }
      };
      reader.readAsText(file);
    };
    function renderAll() {
      if (appState.app.tree.persons.length === 0) {
        showEmptyState(true);
      } else {
        showEmptyState(false);
      }
      renderTreeCanvas();
      updateSidebarPersons();
    }
    document.getElementById('add-first-btn').onclick = function() {
      openPersonModal(null, { create: true });
    };
    window.onload = renderAll;
    document.getElementById('person-list').onkeydown = function(e){
      if (e.key==='Enter' && e.target.classList.contains('person-list-item')) {
        let pid = e.target.getAttribute('data-personid');
        openPersonModal(pid);
      }
    };
  </script>
</body>
</html>
