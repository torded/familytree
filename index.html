<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Tree Creator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            display: flex;
            height: 100vh;
            background-color: #f5f5f5;
            overflow: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 300px;
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            margin-bottom: 20px;
        }

        .sidebar-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .sidebar-subtitle {
            font-size: 14px;
            color: #bdc3c7;
            margin-bottom: 20px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .person-list {
            flex: 1;
            overflow-y: auto;
        }

        .person-list-title {
            font-size: 18px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #34495e;
        }

        .person-item {
            background-color: #34495e;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .person-item:hover {
            background-color: #2c3e50;
        }

        .person-item.active {
            background-color: #3498db;
        }

        .person-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .person-details {
            font-size: 12px;
            color: #bdc3c7;
        }

        /* Main Canvas Styles */
        .main-canvas {
            flex: 1;
            background-color: white;
            position: relative;
            overflow: auto;
            padding: 20px;
        }

        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .empty-state-btn {
            background-color: #3498db;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .empty-state-btn:hover {
            background-color: #2980b9;
        }

        /* Tree Node Styles */
        .tree-node {
            position: absolute;
            width: 200px;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tree-node:hover {
            transform: scale(1.05);
        }

        .tree-node.male {
            background-color: #e3f2fd;
            border: 2px solid #90caf9;
        }

        .tree-node.female {
            background-color: #fce4ec;
            border: 2px solid #f8bbd0;
        }

        .node-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #ddd;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .node-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .node-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
            text-align: center;
        }

        .node-dates {
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        .node-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }

        .node-action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .edit-btn {
            background-color: #3498db;
            color: white;
        }

        .delete-btn {
            background-color: #e74c3c;
            color: white;
        }

        /* Connection Lines */
        .connection-line {
            position: absolute;
            background-color: #95a5a6;
            z-index: -1;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
        }

        .photo-upload {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .photo-preview {
            width: 80px;
            height: 80px;
            border-radius: 4px;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Relationship Section */
        .relationship-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .relationship-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .relationship-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .relationship-list {
            margin-top: 10px;
        }

        .relationship-item {
            background-color: #f5f5f5;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-relationship {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 16px;
        }

        /* Dropdown for person selection */
        .person-dropdown {
            position: relative;
        }

        .dropdown-content {
            position: absolute;
            background-color: white;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            padding: 10px;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background-color: #f5f5f5;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
            }

            .tree-node {
                width: 180px;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Family Tree Creator</div>
            <div class="sidebar-subtitle">Build and manage your family tree</div>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" id="importBtn">Import Data</button>
            <button class="btn btn-secondary" id="exportBtn">Export Data</button>
            <button class="btn btn-secondary" id="freshStartBtn">Start Fresh</button>
        </div>

        <div class="person-list">
            <div class="person-list-title">Family Members</div>
            <div id="personList"></div>
        </div>
    </div>

    <div class="main-canvas" id="treeCanvas">
        <div class="empty-state" id="emptyState">
            <button class="empty-state-btn" id="addFirstPersonBtn">Add First Person</button>
        </div>
    </div>

    <!-- Person Modal -->
    <div class="modal-overlay" id="personModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Add Person</div>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Photo</label>
                    <div class="photo-upload">
                        <div class="photo-preview" id="photoPreview">
                            <span>No photo</span>
                        </div>
                        <div>
                            <input type="file" id="photoUpload" accept="image/*" style="display: none;">
                            <button class="btn btn-secondary" id="uploadPhotoBtn">Upload Photo</button>
                            <button class="btn btn-secondary" id="removePhotoBtn">Remove</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input type="text" class="form-input" id="firstName" placeholder="Enter first name">
                </div>

                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input type="text" class="form-input" id="lastName" placeholder="Enter last name">
                </div>

                <div class="form-group">
                    <label class="form-label">Birth Year</label>
                    <input type="number" class="form-input" id="birthYear" placeholder="Enter birth year">
                </div>

                <div class="form-group">
                    <label class="form-label">Death Year (optional)</label>
                    <input type="number" class="form-input" id="deathYear" placeholder="Enter death year">
                </div>

                <div class="form-group">
                    <label class="form-label">Gender</label>
                    <select class="form-select" id="gender">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>

                <div class="relationship-section">
                    <div class="relationship-title">Relationships</div>
                    <div class="relationship-buttons">
                        <button class="btn btn-primary" id="addParentBtn">Add Parent</button>
                        <button class="btn btn-primary" id="addChildBtn">Add Child</button>
                        <button class="btn btn-primary" id="addSpouseBtn">Add Spouse</button>
                    </div>
                    
                    <div class="relationship-list" id="relationshipList"></div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" id="deletePersonBtn">Delete Person</button>
                <button class="btn btn-primary" id="savePersonBtn">Save</button>
            </div>
        </div>
    </div>

    <!-- Relationship Modal -->
    <div class="modal-overlay" id="relationshipModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="relationshipModalTitle">Add Relationship</div>
                <button class="modal-close" id="relationshipModalClose">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Person</label>
                    <div class="person-dropdown">
                        <select class="form-select" id="personSelect">
                            <option value="">Select a person</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Or create new person</label>
                    <button class="btn btn-primary" id="createNewPersonBtn">Create New Person</button>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelRelationshipBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmRelationshipBtn">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let appState = {
            app: {
                settings: {},
                tree: {
                    persons: [],
                    relations: []
                }
            }
        };

        let currentEditingPersonId = null;
        let currentRelationshipType = null;
        let currentRelationshipSourceId = null;

        // DOM Elements
        const personListElement = document.getElementById('personList');
        const treeCanvasElement = document.getElementById('treeCanvas');
        const emptyStateElement = document.getElementById('emptyState');
        const addFirstPersonBtn = document.getElementById('addFirstPersonBtn');
        const importBtn = document.getElementById('importBtn');
        const exportBtn = document.getElementById('exportBtn');

        // Modal Elements
        const personModal = document.getElementById('personModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalClose = document.getElementById('modalClose');
        const photoUpload = document.getElementById('photoUpload');
        const uploadPhotoBtn = document.getElementById('uploadPhotoBtn');
        const removePhotoBtn = document.getElementById('removePhotoBtn');
        const photoPreview = document.getElementById('photoPreview');
        const firstNameInput = document.getElementById('firstName');
        const lastNameInput = document.getElementById('lastName');
        const birthYearInput = document.getElementById('birthYear');
        const deathYearInput = document.getElementById('deathYear');
        const genderSelect = document.getElementById('gender');
        const savePersonBtn = document.getElementById('savePersonBtn');
        const deletePersonBtn = document.getElementById('deletePersonBtn');
        const addParentBtn = document.getElementById('addParentBtn');
        const addChildBtn = document.getElementById('addChildBtn');
        const addSpouseBtn = document.getElementById('addSpouseBtn');
        const relationshipList = document.getElementById('relationshipList');
        const freshStartBtn = document.getElementById('freshStartBtn');

        // Relationship Modal Elements
        const relationshipModal = document.getElementById('relationshipModal');
        const relationshipModalTitle = document.getElementById('relationshipModalTitle');
        const relationshipModalClose = document.getElementById('relationshipModalClose');
        const personSelect = document.getElementById('personSelect');
        const createNewPersonBtn = document.getElementById('createNewPersonBtn');
        const cancelRelationshipBtn = document.getElementById('cancelRelationshipBtn');
        const confirmRelationshipBtn = document.getElementById('confirmRelationshipBtn');

        // Initialize the application
        function init() {
            // Set up event listeners
            addFirstPersonBtn.addEventListener('click', showAddPersonModal);
            importBtn.addEventListener('click', importData);
            exportBtn.addEventListener('click', exportData);
            freshStartBtn.addEventListener('click', freshStart);
            modalClose.addEventListener('click', closePersonModal);
            uploadPhotoBtn.addEventListener('click', () => photoUpload.click());
            photoUpload.addEventListener('change', handlePhotoUpload);
            removePhotoBtn.addEventListener('click', removePhoto);
            savePersonBtn.addEventListener('click', savePerson);
            deletePersonBtn.addEventListener('click', deletePerson);
            addParentBtn.addEventListener('click', () => showRelationshipModal('parent'));
            addChildBtn.addEventListener('click', () => showRelationshipModal('child'));
            addSpouseBtn.addEventListener('click', () => showRelationshipModal('spouse'));
            relationshipModalClose.addEventListener('click', closeRelationshipModal);
            cancelRelationshipBtn.addEventListener('click', closeRelationshipModal);
            confirmRelationshipBtn.addEventListener('click', confirmRelationship);
            createNewPersonBtn.addEventListener('click', createNewPersonFromRelationship);

            // Set up window unload protection
            window.addEventListener('beforeunload', handleBeforeUnload);

            // Check URL parameters for fresh start
            const urlParams = new URLSearchParams(window.location.search);
            const freshStart = urlParams.get('fresh') === 'true';

            if (freshStart) {
                // Force fresh start if ?fresh=true is in URL
                localStorage.removeItem('familyTreeData');
                appState = {
                    app: {
                        settings: {},
                        tree: {
                            persons: [],
                            relations: []
                        }
                    }
                };
                renderApp();
            } else {
                // Check if there's any data in localStorage from previous session
                const savedData = localStorage.getItem('familyTreeData');
                if (savedData) {
                    try {
                        appState = JSON.parse(savedData);
                        // Check if there are actually persons in the data
                        if (appState.app.tree.persons.length === 0) {
                            // Force fresh start if no persons
                            appState = {
                                app: {
                                    settings: {},
                                    tree: {
                                        persons: [],
                                        relations: []
                                    }
                                }
                            };
                        }
                        renderApp();
                    } catch (e) {
                        console.error('Error loading saved data:', e);
                        // Start fresh if there's an error
                        appState = {
                            app: {
                                settings: {},
                                tree: {
                                    persons: [],
                                    relations: []
                                }
                            }
                        };
                        renderApp();
                    }
                } else {
                    // Start fresh if no saved data
                    appState = {
                        app: {
                            settings: {},
                            tree: {
                                persons: [],
                                relations: []
                            }
                        }
                    };
                    renderApp();
                }
            }
        }

        // Fresh start function
        function freshStart() {
            if (confirm('Are you sure you want to start fresh? This will delete all your family tree data.')) {
                localStorage.removeItem('familyTreeData');
                window.location.reload();
            }
        }

        // Handle before unload to warn about unsaved changes
        function handleBeforeUnload(e) {
            const hasData = appState.app.tree.persons.length > 0;
            if (hasData) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                return e.returnValue;
            }
        }

        // Main render function
        function renderApp() {
            renderPersonList();
            renderTree();
        }

        // Render person list in sidebar
        function renderPersonList() {
            personListElement.innerHTML = '';
            
            if (appState.app.tree.persons.length === 0) {
                personListElement.innerHTML = '<div class="person-item">No family members yet</div>';
                return;
            }

            appState.app.tree.persons.forEach(person => {
                const personElement = document.createElement('div');
                personElement.className = 'person-item';
                personElement.dataset.id = person.id;
                
                const birthYear = person.birthDate || '?';
                const deathYear = person.deathDate || '?';
                const years = person.deathDate ? `${birthYear} - ${deathYear}` : `b. ${birthYear}`;

                personElement.innerHTML = `
                    <div class="person-name">${person.firstName} ${person.lastName}</div>
                    <div class="person-details">${years} â€¢ ${person.gender}</div>
                `;

                personElement.addEventListener('click', () => {
                    // Remove active class from all items
                    document.querySelectorAll('.person-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Add active class to clicked item
                    personElement.classList.add('active');
                    
                    // Show edit modal for this person
                    showEditPersonModal(person.id);
                });

                personListElement.appendChild(personElement);
            });
        }

        // Render the family tree
        function renderTree() {
            // Clear existing tree
            treeCanvasElement.innerHTML = '';

            if (appState.app.tree.persons.length === 0) {
                emptyStateElement.style.display = 'block';
                return;
            }

            emptyStateElement.style.display = 'none';

            // This is a simplified tree rendering - in a real app, you'd use a proper
            // tree layout algorithm. For this demo, we'll position nodes in a basic hierarchy.
            
            // Find root persons (those with no parents)
            const rootPersons = findRootPersons();

            if (rootPersons.length === 0) {
                // If no roots found, show all persons
                renderAllPersons();
            } else {
                // Render tree starting from roots
                renderTreeFromRoots(rootPersons);
            }
        }

        function findRootPersons() {
            const personIds = appState.app.tree.persons.map(p => p.id);
            const childIds = appState.app.tree.relations
                .filter(r => r.type === 'child')
                .map(r => r.to);
            
            return appState.app.tree.persons.filter(person => 
                !childIds.includes(person.id)
            );
        }

        function renderAllPersons() {
            // Simple grid layout for all persons
            const container = document.createElement('div');
            container.style.display = 'flex';
            container.style.flexWrap = 'wrap';
            container.style.gap = '30px';
            container.style.padding = '20px';

            appState.app.tree.persons.forEach((person, index) => {
                const node = createPersonNode(person);
                node.style.position = 'relative';
                node.style.left = `${(index % 4) * 230}px`;
                node.style.top = `${Math.floor(index / 4) * 250}px`;
                container.appendChild(node);
            });

            treeCanvasElement.appendChild(container);
        }

        function renderTreeFromRoots(roots) {
            // This is a simplified tree rendering approach
            // In a production app, you'd use a proper tree layout algorithm
            
            const container = document.createElement('div');
            container.style.position = 'relative';
            container.style.width = '100%';
            container.style.height = '100%';

            // Position roots at the top
            roots.forEach((person, index) => {
                const rootNode = createPersonNode(person);
                rootNode.style.left = `${100 + index * 250}px`;
                rootNode.style.top = '50px';
                container.appendChild(rootNode);

                // Render children
                renderChildren(person.id, 100 + index * 250, 200, container);
            });

            treeCanvasElement.appendChild(container);
        }

        function renderChildren(parentId, parentX, parentY, container) {
            // Find children of this parent
            const children = appState.app.tree.relations
                .filter(r => r.type === 'parent' && r.from === parentId)
                .map(r => appState.app.tree.persons.find(p => p.id === r.to))
                .filter(p => p);

            if (children.length === 0) return;

            // Position children below parent
            children.forEach((child, index) => {
                const childX = parentX + (index - Math.floor(children.length / 2)) * 150;
                const childY = parentY + 150;

                const childNode = createPersonNode(child);
                childNode.style.left = `${childX}px`;
                childNode.style.top = `${childY}px`;
                container.appendChild(childNode);

                // Draw connection line
                const line = document.createElement('div');
                line.className = 'connection-line';
                line.style.width = '2px';
                line.style.height = `${childY - parentY - 60}px`;
                line.style.left = `${parentX + 100}px`;
                line.style.top = `${parentY + 80}px`;
                container.appendChild(line);

                // Horizontal line to child
                const hLine = document.createElement('div');
                hLine.className = 'connection-line';
                hLine.style.width = `${Math.abs(childX - parentX) - 100}px`;
                hLine.style.height = '2px';
                hLine.style.left = `${Math.min(parentX + 100, childX + 100)}px`;
                hLine.style.top = `${childY - 60}px`;
                container.appendChild(hLine);

                // Vertical line down to child
                const vLine = document.createElement('div');
                vLine.className = 'connection-line';
                vLine.style.width = '2px';
                vLine.style.height = '60px';
                vLine.style.left = `${childX + 100}px`;
                vLine.style.top = `${childY - 60}px`;
                container.appendChild(vLine);

                // Render this child's children
                renderChildren(child.id, childX, childY, container);
            });

            // Render spouse
            const spouseRelation = appState.app.tree.relations
                .find(r => (r.type === 'spouse' && r.from === parentId) || (r.type === 'spouse' && r.to === parentId));

            if (spouseRelation) {
                const spouseId = spouseRelation.from === parentId ? spouseRelation.to : spouseRelation.from;
                const spouse = appState.app.tree.persons.find(p => p.id === spouseId);
                
                if (spouse) {
                    const spouseX = parentX + 250;
                    const spouseY = parentY;

                    const spouseNode = createPersonNode(spouse);
                    spouseNode.style.left = `${spouseX}px`;
                    spouseNode.style.top = `${spouseY}px`;
                    container.appendChild(spouseNode);

                    // Draw spouse connection line
                    const spouseLine = document.createElement('div');
                    spouseLine.className = 'connection-line';
                    spouseLine.style.width = `${spouseX - parentX - 100}px`;
                    spouseLine.style.height = '2px';
                    spouseLine.style.left = `${parentX + 100}px`;
                    spouseLine.style.top = `${parentY + 50}px`;
                    container.appendChild(spouseLine);
                }
            }
        }

        // Create a person node element
        function createPersonNode(person) {
            const node = document.createElement('div');
            node.className = `tree-node ${person.gender}`;
            node.dataset.id = person.id;

            // Photo
            const photoDiv = document.createElement('div');
            photoDiv.className = 'node-photo';
            
            if (person.photo) {
                const img = document.createElement('img');
                img.src = person.photo;
                img.alt = `${person.firstName} ${person.lastName}`;
                photoDiv.appendChild(img);
            } else {
                photoDiv.textContent = 'ðŸ‘¤';
            }

            // Name
            const nameDiv = document.createElement('div');
            nameDiv.className = 'node-name';
            nameDiv.textContent = `${person.firstName} ${person.lastName}`;

            // Dates
            const datesDiv = document.createElement('div');
            datesDiv.className = 'node-dates';
            const birthYear = person.birthDate || '?';
            const deathYear = person.deathDate || '?';
            datesDiv.textContent = person.deathDate ? `${birthYear} - ${deathYear}` : `b. ${birthYear}`;

            // Actions
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'node-actions';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'node-action-btn edit-btn';
            editBtn.textContent = 'Edit';
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showEditPersonModal(person.id);
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'node-action-btn delete-btn';
            deleteBtn.textContent = 'Delete';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm(`Delete ${person.firstName} ${person.lastName}?`)) {
                    deletePersonById(person.id);
                }
            });

            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(deleteBtn);

            // Double click to edit
            node.addEventListener('dblclick', () => showEditPersonModal(person.id));

            node.appendChild(photoDiv);
            node.appendChild(nameDiv);
            node.appendChild(datesDiv);
            node.appendChild(actionsDiv);

            return node;
        }

        // Show add person modal
        function showAddPersonModal() {
            currentEditingPersonId = null;
            modalTitle.textContent = 'Add Person';
            
            // Reset form
            photoPreview.innerHTML = '<span>No photo</span>';
            firstNameInput.value = '';
            lastNameInput.value = '';
            birthYearInput.value = '';
            deathYearInput.value = '';
            genderSelect.value = 'male';
            
            // Hide delete button for new person
            deletePersonBtn.style.display = 'none';
            
            personModal.style.display = 'flex';
        }

        // Show edit person modal
        function showEditPersonModal(personId) {
            const person = appState.app.tree.persons.find(p => p.id === personId);
            if (!person) return;

            currentEditingPersonId = personId;
            modalTitle.textContent = 'Edit Person';
            
            // Set form values
            if (person.photo) {
                photoPreview.innerHTML = `<img src="${person.photo}" alt="${person.firstName} ${person.lastName}">`;
            } else {
                photoPreview.innerHTML = '<span>No photo</span>';
            }
            
            firstNameInput.value = person.firstName || '';
            lastNameInput.value = person.lastName || '';
            birthYearInput.value = person.birthDate || '';
            deathYearInput.value = person.deathDate || '';
            genderSelect.value = person.gender || 'male';
            
            // Show delete button for existing person
            deletePersonBtn.style.display = 'block';
            
            // Render relationships
            renderRelationships(personId);
            
            personModal.style.display = 'flex';
        }

        // Render relationships for current person
        function renderRelationships(personId) {
            relationshipList.innerHTML = '';
            
            // Find all relationships involving this person
            const relationships = appState.app.tree.relations.filter(r => 
                r.from === personId || r.to === personId
            );

            if (relationships.length === 0) {
                relationshipList.innerHTML = '<div>No relationships yet</div>';
                return;
            }

            relationships.forEach(rel => {
                const relElement = document.createElement('div');
                relElement.className = 'relationship-item';
                
                // Find the other person in the relationship
                const otherPersonId = rel.from === personId ? rel.to : rel.from;
                const otherPerson = appState.app.tree.persons.find(p => p.id === otherPersonId);
                
                if (otherPerson) {
                    const relType = rel.type === 'spouse' ? 'Spouse' : 
                                   rel.from === personId ? 'Child' : 'Parent';
                    
                    relElement.innerHTML = `
                        <span>${relType}: ${otherPerson.firstName} ${otherPerson.lastName}</span>
                        <button class="remove-relationship" data-rel-id="${rel.from}-${rel.to}-${rel.type}">Ã—</button>
                    `;
                    
                    relElement.querySelector('.remove-relationship').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeRelationship(rel.from, rel.to, rel.type);
                    });
                    
                    relationshipList.appendChild(relElement);
                }
            });
        }

        // Handle photo upload
        function handlePhotoUpload(e) {
            const file = e.target.files[0];
            if (!file) {
                alert('No file selected');
                return;
            }

            // Check if file is an image
            if (!file.type.match('image.*')) {
                alert('Please select an image file');
                photoUpload.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = document.createElement('img');
                img.src = event.target.result;
                img.alt = 'Preview';
                img.style.maxWidth = '100%';
                img.style.maxHeight = '100%';
                photoPreview.innerHTML = '';
                photoPreview.appendChild(img);
            };
            reader.onerror = function() {
                alert('Error reading the file');
                photoUpload.value = '';
            };
            reader.readAsDataURL(file);
        }

        // Remove photo
        function removePhoto() {
            photoPreview.innerHTML = '<span>No photo</span>';
            photoUpload.value = '';
            console.log('Photo removed');
        }

        // Save person
        function savePerson() {
            const firstName = firstNameInput.value.trim();
            const lastName = lastNameInput.value.trim();
            const birthYear = birthYearInput.value.trim();
            const deathYear = deathYearInput.value.trim();
            const gender = genderSelect.value;
            
            // Get photo data URL
            const photoImg = photoPreview.querySelector('img');
            const photo = photoImg ? photoImg.src : null;

            // Validate required fields
            if (!firstName) {
                alert('Please enter first name');
                firstNameInput.focus();
                return;
            }

            if (!lastName) {
                alert('Please enter last name');
                lastNameInput.focus();
                return;
            }

            // Validate birth year
            if (birthYear && (isNaN(birthYear) || birthYear < 1000 || birthYear > new Date().getFullYear())) {
                alert('Please enter a valid birth year (1000-' + new Date().getFullYear() + ')');
                birthYearInput.focus();
                return;
            }

            // Validate death year
            if (deathYear && (isNaN(deathYear) || deathYear < 1000 || deathYear > new Date().getFullYear())) {
                alert('Please enter a valid death year (1000-' + new Date().getFullYear() + ')');
                deathYearInput.focus();
                return;
            }

            // Validate death year is after birth year
            if (birthYear && deathYear && parseInt(deathYear) < parseInt(birthYear)) {
                alert('Death year must be after birth year');
                deathYearInput.focus();
                return;
            }

            const personData = {
                id: currentEditingPersonId || generateUUID(),
                firstName,
                lastName,
                birthDate: birthYear || null,
                deathDate: deathYear || null,
                gender,
                photo: photo || null
            };

            if (currentEditingPersonId) {
                // Update existing person
                const index = appState.app.tree.persons.findIndex(p => p.id === currentEditingPersonId);
                if (index !== -1) {
                    appState.app.tree.persons[index] = personData;
                    console.log('Person updated:', personData);
                }
            } else {
                // Add new person
                appState.app.tree.persons.push(personData);
                console.log('Person added:', personData);
            }

            // Save to localStorage
            saveToLocalStorage();
            console.log('Data saved to localStorage');

            // Close modal and refresh
            closePersonModal();
            renderApp();
            console.log('UI refreshed');
        }

        // Delete person
        function deletePerson() {
            if (!currentEditingPersonId) return;
            
            if (confirm('Are you sure you want to delete this person? This will also remove all their relationships.')) {
                deletePersonById(currentEditingPersonId);
                closePersonModal();
            }
        }

        // Delete person by ID
        function deletePersonById(personId) {
            // Remove person
            appState.app.tree.persons = appState.app.tree.persons.filter(p => p.id !== personId);
            
            // Remove all relationships involving this person
            appState.app.tree.relations = appState.app.tree.relations.filter(r => 
                r.from !== personId && r.to !== personId
            );
            
            // Save to localStorage
            saveToLocalStorage();
            
            // Refresh UI
            renderApp();
        }

        // Close person modal
        function closePersonModal() {
            personModal.style.display = 'none';
        }

        // Show relationship modal
        function showRelationshipModal(type) {
            currentRelationshipType = type;
            currentRelationshipSourceId = currentEditingPersonId;
            
            // Set modal title based on relationship type
            const titles = {
                'parent': 'Add Parent',
                'child': 'Add Child',
                'spouse': 'Add Spouse'
            };
            relationshipModalTitle.textContent = titles[type] || 'Add Relationship';

            // Populate person dropdown (exclude current person for spouse/parent)
            personSelect.innerHTML = '<option value="">Select a person</option>';
            
            appState.app.tree.persons
                .filter(person => person.id !== currentEditingPersonId)
                .forEach(person => {
                    const option = document.createElement('option');
                    option.value = person.id;
                    option.textContent = `${person.firstName} ${person.lastName} (${person.birthDate || '?'})`;
                    personSelect.appendChild(option);
                });

            relationshipModal.style.display = 'flex';
        }

        // Close relationship modal
        function closeRelationshipModal() {
            relationshipModal.style.display = 'none';
        }

        // Confirm relationship
        function confirmRelationship() {
            const selectedPersonId = personSelect.value;
            
            if (!selectedPersonId) {
                alert('Please select a person');
                return;
            }

            // Check if relationship already exists
            const existingRelation = appState.app.tree.relations.find(r => 
                (r.from === currentRelationshipSourceId && r.to === selectedPersonId && r.type === currentRelationshipType) ||
                (r.from === selectedPersonId && r.to === currentRelationshipSourceId && r.type === currentRelationshipType)
            );

            if (existingRelation) {
                alert('This relationship already exists');
                return;
            }

            // For spouse relationships, order doesn't matter
            // For parent/child, we need to be careful about direction
            let fromId, toId;
            
            if (currentRelationshipType === 'spouse') {
                fromId = currentRelationshipSourceId;
                toId = selectedPersonId;
            } else if (currentRelationshipType === 'parent') {
                // Current person is child, selected person is parent
                fromId = selectedPersonId;
                toId = currentRelationshipSourceId;
            } else if (currentRelationshipType === 'child') {
                // Current person is parent, selected person is child
                fromId = currentRelationshipSourceId;
                toId = selectedPersonId;
            }

            // Add the relationship
            appState.app.tree.relations.push({
                from: fromId,
                to: toId,
                type: currentRelationshipType
            });

            // Save and refresh
            saveToLocalStorage();
            closeRelationshipModal();
            renderApp();
            
            // Reopen person modal to show updated relationships
            if (currentEditingPersonId) {
                showEditPersonModal(currentEditingPersonId);
            }
        }

        // Create new person from relationship modal
        function createNewPersonFromRelationship() {
            closeRelationshipModal();
            showAddPersonModal();
        }

        // Remove relationship
        function removeRelationship(fromId, toId, type) {
            appState.app.tree.relations = appState.app.tree.relations.filter(r => 
                !(r.from === fromId && r.to === toId && r.type === type) &&
                !(r.from === toId && r.to === fromId && r.type === type)
            );
            
            saveToLocalStorage();
            renderApp();
            
            // Reopen person modal to show updated relationships
            if (currentEditingPersonId) {
                showEditPersonModal(currentEditingPersonId);
            }
        }

        // Export data
        function exportData() {
            const dataStr = JSON.stringify(appState, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'family_tree.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Import data
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        // Validate the structure
                        if (importedData.app && importedData.app.tree && 
                            Array.isArray(importedData.app.tree.persons) &&
                            Array.isArray(importedData.app.tree.relations)) {
                            
                            appState = importedData;
                            saveToLocalStorage();
                            renderApp();
                            alert('Data imported successfully!');
                        } else {
                            alert('Invalid file format. Please import a valid family tree JSON file.');
                        }
                    } catch (error) {
                        alert('Error importing file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            });

            input.click();
        }

        // Save to localStorage
        function saveToLocalStorage() {
            try {
                const dataStr = JSON.stringify(appState);
                localStorage.setItem('familyTreeData', dataStr);
                console.log('Successfully saved to localStorage:', dataStr.length, 'bytes');
                return true;
            } catch (e) {
                console.error('Error saving to localStorage:', e);
                alert('Error saving data. Please check console for details.');
                return false;
            }
        }

        // Generate UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>