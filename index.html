<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Tree Creator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            background-color: #f5f5f5;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 300px;
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #34495e;
        }

        .sidebar h2 {
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5em;
        }

        .sidebar-buttons {
            margin-bottom: 30px;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .persons-list {
            margin-top: 20px;
        }

        .persons-list h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .person-item {
            background-color: #34495e;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .person-item:hover {
            background-color: #3d566e;
        }

        .person-item.selected {
            background-color: #3498db;
        }

        /* Main Canvas Styles */
        .main-content {
            flex: 1;
            position: relative;
            background-color: white;
            overflow: auto;
        }

        .initial-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background-color: white;
        }

        .add-first-person-btn {
            padding: 20px 40px;
            font-size: 1.2em;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .add-first-person-btn:hover {
            background-color: #2980b9;
        }

        .canvas-container {
            position: relative;
            min-height: 100%;
            min-width: 100%;
        }

        .person-node {
            position: absolute;
            min-width: 150px;
            padding: 10px;
            border-radius: 6px;
            border: 2px solid #ddd;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .person-node:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .person-node.male {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }

        .person-node.female {
            background-color: #fce4ec;
            border-color: #e91e63;
        }

        .person-photo {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            object-fit: cover;
            margin-bottom: 5px;
            background-color: #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
        }

        .person-name {
            font-weight: bold;
            margin-bottom: 2px;
            word-break: break-word;
        }

        .person-dates {
            font-size: 10px;
            color: #666;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
        }

        .photo-preview {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            object-fit: cover;
            background-color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .relations-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .relation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .relation-actions button {
            margin-left: 5px;
            padding: 4px 8px;
            font-size: 12px;
        }

        /* Connection Lines */
        .connection {
            stroke: #666;
            stroke-width: 2;
            fill: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>Family Tree</h2>

            <div class="sidebar-buttons">
                <button id="importBtn" class="btn btn-primary">Import Data</button>
                <button id="exportBtn" class="btn btn-success">Export Data</button>
            </div>

            <div class="persons-list">
                <h3>Persons</h3>
                <div id="personsContainer"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div id="initialState" class="initial-state">
                <button id="addFirstPersonBtn" class="add-first-person-btn">Add First Person</button>
            </div>
            <div id="canvasContainer" class="canvas-container" style="display: none;"></div>
        </div>
    </div>

    <!-- Edit Person Modal -->
    <div id="editModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Edit Person</div>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editPersonId">

                <div class="form-group">
                    <label>Photo</label>
                    <input type="file" id="photoInput" accept="image/*" class="form-control">
                    <div id="photoPreview" class="photo-preview">üì∑</div>
                </div>

                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" id="firstNameInput" class="form-control">
                </div>

                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" class="form-control" id="lastNameInput">
                </div>

                <div class="form-group">
                    <label>Birth Year</label>
                    <input type="text" id="birthYearInput" class="form-control" placeholder="YYYY">
                </div>

                <div class="form-group">
                    <label>Death Year</label>
                    <input type="text" id="deathYearInput" class="form-control" placeholder="YYYY">
                </div>

                <div class="form-group">
                    <label>Gender</label>
                    <select id="genderInput" class="form-control">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>

                <div class="relations-section">
                    <h4>Relationships</h4>

                    <div class="form-group">
                        <button id="addParentBtn" class="btn btn-primary">Add Parent</button>
                        <button id="addChildBtn" class="btn btn-primary">Add Child</button>
                        <button id="addSpouseBtn" class="btn btn-primary">Add Spouse</button>
                    </div>

                    <div id="relationsList"></div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <button id="savePersonBtn" class="btn btn-success">Save</button>
                    <button id="deletePersonBtn" class="btn btn-danger">Delete Person</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let appState = {
            app: {
                settings: {},
                tree: {
                    persons: [],
                    relations: []
                }
            }
        };

        let selectedPersonId = null;
        let nextId = 1;

        // DOM Elements
        const elements = {
            initialState: document.getElementById('initialState'),
            canvasContainer: document.getElementById('canvasContainer'),
            personsContainer: document.getElementById('personsContainer'),
            importBtn: document.getElementById('importBtn'),
            exportBtn: document.getElementById('exportBtn'),
            addFirstPersonBtn: document.getElementById('addFirstPersonBtn'),
            editModal: document.getElementById('editModal'),
            editPersonId: document.getElementById('editPersonId'),
            photoInput: document.getElementById('photoInput'),
            photoPreview: document.getElementById('photoPreview'),
            firstNameInput: document.getElementById('firstNameInput'),
            lastNameInput: document.getElementById('lastNameInput'),
            birthYearInput: document.getElementById('birthYearInput'),
            deathYearInput: document.getElementById('deathYearInput'),
            genderInput: document.getElementById('genderInput'),
            relationsList: document.getElementById('relationsList'),
            savePersonBtn: document.getElementById('savePersonBtn'),
            deletePersonBtn: document.getElementById('deletePersonBtn'),
            addParentBtn: document.getElementById('addParentBtn'),
            addChildBtn: document.getElementById('addChildBtn'),
            addSpouseBtn: document.getElementById('addSpouseBtn'),
            closeBtn: document.querySelector('.close-btn')
        };

        // Initialize the app
        function init() {
            setupEventListeners();
            updateUI();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Button events
            elements.addFirstPersonBtn.addEventListener('click', () => {
                openEditModal(null);
            });

            elements.importBtn.addEventListener('click', importData);
            elements.exportBtn.addEventListener('click', exportData);

            elements.savePersonBtn.addEventListener('click', savePerson);
            elements.deletePersonBtn.addEventListener('click', deletePerson);
            elements.closeBtn.addEventListener('click', closeEditModal);

            elements.addParentBtn.addEventListener('click', () => addRelation('parent'));
            elements.addChildBtn.addEventListener('click', () => addRelation('child'));
            elements.addSpouseBtn.addEventListener('click', () => addRelation('spouse'));

            // Photo input event
            elements.photoInput.addEventListener('change', handlePhotoUpload);

            // Prevent closing without export
            window.addEventListener('beforeunload', (e) => {
                if (appState.app.tree.persons.length > 0) {
                    e.preventDefault();
                    e.returnValue = '';
                    return 'You have unsaved data. Are you sure you want to leave?';
                }
            });
        }

        // Handle photo upload and convert to base64
        function handlePhotoUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const base64String = event.target.result;
                    elements.photoPreview.innerHTML = `<img src="${base64String}" alt="Preview" style="width: 100%; height: 100%; border-radius: 8px;">`;
                };
                reader.readAsDataURL(file);
            }
        }

        // Open edit modal
        function openEditModal(personId) {
            const person = personId ? appState.app.tree.persons.find(p => p.id === personId) : null;

            if (person) {
                elements.editPersonId.value = person.id;
                elements.firstNameInput.value = person.firstName || '';
                elements.lastNameInput.value = person.lastName || '';
                elements.birthYearInput.value = person.birthDate || '';
                elements.deathYearInput.value = person.deathDate || '';
                elements.genderInput.value = person.gender || 'male';

                if (person.photo) {
                    elements.photoPreview.innerHTML = `<img src="${person.photo}" alt="Preview" style="width: 100%; height: 100%; border-radius: 8px;">`;
                } else {
                    elements.photoPreview.innerHTML = 'üì∑';
                }
            } else {
                // Clear form for new person
                elements.editPersonId.value = '';
                elements.firstNameInput.value = '';
                elements.lastNameInput.value = '';
                elements.birthYearInput.value = '';
                elements.deathYearInput.value = '';
                elements.genderInput.value = 'male';
                elements.photoPreview.innerHTML = 'üì∑';
                elements.photoInput.value = '';
            }

            updateRelationsList(personId);
            elements.editModal.style.display = 'flex';
        }

        // Close edit modal
        function closeEditModal() {
            elements.editModal.style.display = 'none';
        }

        // Save person
        function savePerson() {
            const id = elements.editPersonId.value || 'person_' + Date.now();
            const firstName = elements.firstNameInput.value.trim();
            const lastName = elements.lastNameInput.value.trim();
            const birthDate = elements.birthYearInput.value.trim();
            const deathDate = elements.deathYearInput.value.trim();
            const gender = elements.genderInput.value;

            // Get photo data
            let photo = null;
            if (elements.photoInput.files[0]) {
                // This is a new photo upload - handled by the change event
                // We need to get the base64 from the preview if it exists
                const imgElement = elements.photoPreview.querySelector('img');
                if (imgElement) {
                    photo = imgElement.src;
                }
            } else {
                // Check if we have an existing photo
                const existingPerson = appState.app.tree.persons.find(p => p.id === id);
                if (existingPerson) {
                    photo = existingPerson.photo;
                }
            }

            const person = {
                id,
                firstName,
                lastName,
                birthDate,
                deathDate,
                gender,
                photo
            };

            // Add or update person
            const existingIndex = appState.app.tree.persons.findIndex(p => p.id === id);
            if (existingIndex >= 0) {
                appState.app.tree.persons[existingIndex] = person;
            } else {
                appState.app.tree.persons.push(person);
            }

            closeEditModal();
            updateUI();
        }

        // Delete person
        function deletePerson() {
            if (!confirm('Are you sure you want to delete this person and all their relationships?')) {
                return;
            }

            const personId = elements.editPersonId.value;
            if (personId) {
                // Remove person
                appState.app.tree.persons = appState.app.tree.persons.filter(p => p.id !== personId);

                // Remove all relations involving this person
                appState.app.tree.relations = appState.app.tree.relations.filter(
                    r => r.from !== personId && r.to !== personId
                );
            }

            closeEditModal();
            updateUI();
        }

        // Add relation
        function addRelation(type) {
            const currentPersonId = elements.editPersonId.value;
            if (!currentPersonId) return;

            const options = appState.app.tree.persons
                .filter(p => p.id !== currentPersonId)
                .map(p => ({
                    id: p.id,
                    name: `${p.firstName} ${p.lastName}`
                }));

            const choice = prompt(
                `Choose an option:\n1. Select existing person: ${options.map((o, i) => `\n${i + 1}. ${o.name}`).join('')}\n\nOr enter a new person's name`
            );

            if (choice === null) return;

            let relatedPersonId = null;
            const choiceNum = parseInt(choice) - 1;

            if (!isNaN(choiceNum) && choiceNum >= 0 && choiceNum < options.length) {
                // Selected existing person
                relatedPersonId = options[choiceNum].id;
            } else {
                // Create new person
                const newPersonName = choice.trim();
                if (!newPersonName) return;

                const newNameParts = newPersonName.split(' ');
                const firstName = newNameParts[0];
                const lastName = newNameParts.slice(1).join(' ') || '';

                const newPerson = {
                    id: 'person_' + Date.now(),
                    firstName,
                    lastName,
                    birthDate: '',
                    deathDate: '',
                    gender: 'male',
                    photo: null
                };

                appState.app.tree.persons.push(newPerson);
                relatedPersonId = newPerson.id;
            }

            // Determine the relationship direction based on type
            let fromId, toId;
            switch (type) {
                case 'parent':
                    fromId = relatedPersonId;
                    toId = currentPersonId;
                    break;
                case 'child':
                    fromId = currentPersonId;
                    toId = relatedPersonId;
                    break;
                case 'spouse':
                    // For spouses, we'll add both directions
                    fromId = currentPersonId;
                    toId = relatedPersonId;
                    break;
            }

            // Add relation
            const relation = {
                from: fromId,
                to: toId,
                type: type
            };

            appState.app.tree.relations.push(relation);

            // For spouse, also add reverse relation
            if (type === 'spouse') {
                appState.app.tree.relations.push({
                    from: toId,
                    to: fromId,
                    type: type
                });
            }

            updateRelationsList(currentPersonId);
            updateUI();
        }

        // Update relations list in modal
        function updateRelationsList(personId) {
            if (!personId) return;

            elements.relationsList.innerHTML = '';

            const relations = appState.app.tree.relations.filter(r => r.from === personId || r.to === personId);

            relations.forEach(relation => {
                const relatedId = relation.from === personId ? relation.to : relation.from;
                const relatedPerson = appState.app.tree.persons.find(p => p.id === relatedId);

                if (relatedPerson) {
                    const relationType = relation.type.charAt(0).toUpperCase() + relation.type.slice(1);
                    const direction = relation.from === personId ? '‚Üí' : '‚Üê';

                    const relationItem = document.createElement('div');
                    relationItem.className = 'relation-item';
                    relationItem.innerHTML = `
                        <span>${direction} ${relationType}: ${relatedPerson.firstName} ${relatedPerson.lastName}</span>
                        <div class="relation-actions">
                            <button onclick="removeRelation('${relation.from}', '${relation.to}', '${relation.type}')" class="btn btn-danger">Remove</button>
                        </div>
                    `;

                    elements.relationsList.appendChild(relationItem);
                }
            });
        }

        // Remove relation
        function removeRelation(fromId, toId, type) {
            appState.app.tree.relations = appState.app.tree.relations.filter(
                r => !(r.from === fromId && r.to === toId && r.type === type)
            );

            // Also remove reverse spouse relation
            if (type === 'spouse') {
                appState.app.tree.relations = appState.app.tree.relations.filter(
                    r => !(r.from === toId && r.to === fromId && r.type === type)
                );
            }

            updateUI();
        }

        // Update UI based on current state
        function updateUI() {
            // Update persons list in sidebar
            updatePersonsList();

            // Update canvas
            updateCanvas();

            // Show/hide initial state
            if (appState.app.tree.persons.length === 0) {
                elements.initialState.style.display = 'flex';
                elements.canvasContainer.style.display = 'none';
            } else {
                elements.initialState.style.display = 'none';
                elements.canvasContainer.style.display = 'block';
            }
        }

        // Update persons list in sidebar
        function updatePersonsList() {
            elements.personsContainer.innerHTML = '';

            appState.app.tree.persons.forEach(person => {
                const personItem = document.createElement('div');
                personItem.className = 'person-item';
                personItem.textContent = `${person.firstName} ${person.lastName}`;
                personItem.onclick = () => openEditModal(person.id);

                if (selectedPersonId === person.id) {
                    personItem.classList.add('selected');
                }

                elements.personsContainer.appendChild(personItem);
            });
        }

        // Update canvas with family tree visualization
        function updateCanvas() {
            elements.canvasContainer.innerHTML = '';

            // Create SVG for connections
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('class', 'connections-svg');
            svg.setAttribute('style', 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;');
            elements.canvasContainer.appendChild(svg);

            // Add person nodes
            appState.app.tree.persons.forEach((person, index) => {
                const node = document.createElement('div');
                node.className = `person-node ${person.gender}`;
                node.id = `node-${person.id}`;

                const birthDate = person.birthDate ? person.birthDate : '?';
                const deathDate = person.deathDate ? person.deathDate : '?';

                node.innerHTML = `
                    <div class="person-photo">${person.photo ? `<img src="${person.photo}" alt="" style="width: 100%; height: 100%; border-radius: 4px;">` : 'üë§'}</div>
                    <div class="person-name">${person.firstName} ${person.lastName}</div>
                    <div class="person-dates">${birthDate} - ${deathDate}</div>
                `;

                // Position nodes in a grid layout
                const cols = Math.ceil(Math.sqrt(appState.app.tree.persons.length));
                const row = Math.floor(index / cols);
                const col = index % cols;

                node.style.left = `${col * 180 + 50}px`;
                node.style.top = `${row * 180 + 50}px`;

                node.onclick = () => openEditModal(person.id);
                elements.canvasContainer.appendChild(node);
            });

            // Draw connections
            drawConnections(svg);
        }

        // Draw connections between related persons
        function drawConnections(svg) {
            svg.innerHTML = '';

            appState.app.tree.relations.forEach(relation => {
                const fromNode = document.getElementById(`node-${relation.from}`);
                const toNode = document.getElementById(`node-${relation.to}`);

                if (fromNode && toNode) {
                    const fromRect = fromNode.getBoundingClientRect();
                    const toRect = toNode.getBoundingClientRect();

                    // Calculate positions relative to canvas container
                    const canvasRect = elements.canvasContainer.getBoundingClientRect();

                    const fromX = fromRect.left - canvasRect.left + fromRect.width / 2;
                    const fromY = fromRect.top - canvasRect.top + fromRect.height / 2;
                    const toX = toRect.left - canvasRect.left + toRect.width / 2;
                    const toY = toRect.top - canvasRect.top + toRect.height / 2;

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', fromX);
                    line.setAttribute('y1', fromY);
                    line.setAttribute('x2', toX);
                    line.setAttribute('y2', toY);
                    line.setAttribute('stroke', '#666');
                    line.setAttribute('stroke-width', '2');

                    svg.appendChild(line);
                }
            });
        }

        // Import data from JSON file
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();

                reader.onload = (event) => {
                    try {
                        const importedState = JSON.parse(event.target.result);

                        // Validate structure
                        if (!importedState.app || !importedState.app.tree) {
                            alert('Invalid file format');
                            return;
                        }

                        appState = importedState;
                        updateUI();
                    } catch (error) {
                        alert('Error parsing JSON file');
                    }
                };

                reader.readAsText(file);
            };

            input.click();
        }

        // Export data to JSON file
        function exportData() {
            const dataStr = JSON.stringify(appState, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});

            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'family_tree.json';
            link.click();
        }

        // Make functions available globally for inline handlers
        window.removeRelation = removeRelation;

        // Start the app
        init();
    </script>
</body>
</html>